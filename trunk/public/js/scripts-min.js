var intervalVotes=false;var usedGeolocation=false;var oldVoteData=null;var voting_over_interval_multiplier=1;var venues_ajax_query=Array();var ajax_retry_time_max=3000;var ajax_retry_count_max=10;function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|MIDP|Nokia|J2ME/i.test(navigator.userAgent)}$.extend({keys:function(c){var b=[];$.each(c,function(a){b.push(a)});return b}});function custom_userid_generate(a){$.ajax({type:"POST",url:"customuserid.php",data:{action:"custom_userid_generate",userid:$("#userid").html()},dataType:"json",success:function(b){if(typeof b.alert!="undefined"){alert(b.alert)}else{if(typeof b.access_url!="undefined"){$("#custom_userid_url").html(b.access_url)}else{alert("Fehler beim Erstellen der externen Zugriffs-URL.")}}},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){custom_userid_generate(a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Erstellen der externen Zugriffs-URL.")}}})}function vote_helper(d,b,c,a){$.ajax({type:"POST",url:"vote.php",data:{action:d,identifier:b,note:c,userid:$("#userid").html()},dataType:"json",success:function(e){if(intervalVotes){clearInterval(intervalVotes)}if(typeof e.voting_over!="undefined"&&e.voting_over||!e||typeof e.alert!="undefined"){voting_over_interval_multiplier+=0.1}else{voting_over_interval_multiplier=1}intervalVotes=setInterval(function(){vote_get()},Math.floor(5000*voting_over_interval_multiplier));if(typeof JSON!="undefined"&&JSON.stringify(oldVoteData)==JSON.stringify(e)&&typeof e.alert=="undefined"){return}if(typeof e.alert!="undefined"){alert(e.alert)}else{if(typeof e.html!="undefined"){$("#dialog_ajax_data").html(e.html);$("#dialog_vote_summary").css("display","table");if(!e.voting_over){$("#dialog_vote_summary").effect("highlight")}}else{if(intervalVotes){$("#dialog_vote_summary").hide()}}}oldVoteData=e},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){vote_helper(d,b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Setzen des Votes.")}}})}function vote_up(a){vote_helper("vote_up",a,null,0)}function vote_down(a){vote_helper("vote_down",a,null,0)}function vote_special(a){vote_helper("vote_special",a,null,0)}function vote_set_note(a){vote_helper("vote_set_note",null,a,0)}function vote_get(){vote_helper("vote_get",null,null,0)}function vote_delete(){vote_helper("vote_delete",null,null,0)}function vote_delete_part(a){vote_helper("vote_delete_part",a,null,0)}function positionHandler(a){lat=a.coords.latitude;lng=a.coords.longitude;$.ajax({type:"POST",url:"locator.php",data:{action:"latlngToAddress",lat:lat,lng:lng,userid:$("#userid").html()},dataType:"json",success:function(b){if(b&&typeof b.address!="undefined"&&b.address){usedGeolocation=true;$("#location").html(b.address);$("#locationInput").val(b.address);sortVenuesAfterPosition(lat,lng)}},error:function(){sortVenuesAfterPosition(lat,lng)}})}function positionErrorHandler(a){sortVenuesAfterPosition($("#lat").html(),$("#lng").html())}function distanceLatLng(g,m,f,k){g=parseFloat(g);m=parseFloat(m);f=parseFloat(f);k=parseFloat(k);var e=Math.PI/180;g*=e;m*=e;f*=e;k*=e;var d=6372.797;var h=f-g;var i=k-m;var l=Math.sin(h/2)*Math.sin(h/2)+Math.cos(g)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2);var j=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));var b=d*j;return b}function sortVenuesAfterPosition(d,c){$("#lat").html(d);$("#lng").html(c);var a=new Array();$.each($('[class="venueDiv"]'),function(){var g=$(this).prop("id");var e=$(this).children(".lat").html();var f=$(this).children(".lng").html();a[g]=distanceLatLng(d,c,e,f)});var b=$('[class="venueDiv"]');b.sort(function(g,f){var e=$(g).prop("id");var j=$(f).prop("id");var i=a[e];var h=a[j];if(i>h){return 1}else{if(i<h){return -1}else{return 0}}});$("#venueContainer").html(b);$(document).trigger("locationReady")}function setLocation(b,c,a){if(!b||c){if((isMobileDevice()||c)&&navigator.geolocation){navigator.geolocation.getCurrentPosition(positionHandler,positionErrorHandler,{timeout:5000})}else{sortVenuesAfterPosition($("#lat").html(),$("#lng").html());usedGeolocation=false;$(document).trigger("locationReady")}$.removeCookie("location");return}usedGeolocation=false;$.ajax({type:"POST",url:"locator.php",data:{action:"addressToLatLong",address:b,userid:$("#userid").html()},dataType:"json",success:function(d){if(d&&typeof d.lat!="undefined"&&d.lat&&typeof d.lng!="undefined"&&d.lng){$("#location").html(b);$("#locationInput").val(b);sortVenuesAfterPosition(d.lat,d.lng);$.cookie("location",b,{expires:7})}else{$("#locationInput").val($("#location").html());alert("Keine Geo-Daten zu dieser Adresse gefunden.")}},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){setLocation(b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abrufen der Geo-Position. Bitte Internetverbindung überprüfen.")}}})}function setLocationDialog(a){$("#setLocationDialog").dialog({modal:true,resizable:false,title:"Adresse festlegen",buttons:{Ok:function(){var b=$("#locationInput").val();setLocation(b,false,0);$("#setLocationDialog").dialog("close");$(this).dialog("close")},Abbrechen:function(){$(this).dialog("close")}},width:"auto"});$(a).tooltip("close")}function setDistance(a){if(typeof a!="undefined"){$("#sliderDistance").slider("option","value",a);$("#distance").val(a);$.cookie("distance",a,{expires:7})}get_venues_distance()}function showLocation(d){var g=$("#lat").html()+","+$("#lng").html();var f="http://maps.googleapis.com/maps/api/staticmap?center="+g+"&amp;zoom=15&amp;language=de&amp;size=400x300&amp;sensor=false&amp;markers=color:red|"+g;var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var c=0;var b="";$.each($('[class="venueDiv"]:visible'),function(){var h=$(this).children(".lat").html();var i=$(this).children(".lng").html();var j=$(this).children('[class="title"]').children("a").html();f+="&amp;markers=color:red|label:"+a[c]+"|"+h+","+i;if(c<5){b+=a[c]+": "+j+"<br />"}c++;if(c>=a.length){c=0}});var e='<img width="400" height="300" src="'+f+'"></img>';e+='<br /><div class="locationMapLegend" style="">'+b+"</div>";alert(e,$("#location").html(),false,425);$(d).tooltip("close")}function get_venues_distance(){var d=$("#lat").html();var b=$("#lng").html();var e=$("#distance").val();var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var c=0;$.each($('[class="venueDiv"]'),function(){var h=$(this).children(".lat").html();var k=$(this).children(".lng").html();var j=$(this);var f="";var i=distanceLatLng(d,b,h,k);var g=Math.floor(Number((i).toFixed(2))*1000);if(i>=1){f="~ "+i.toFixed(1)+" km"}else{f="~ "+g+" m"}if(g>e){$(this).hide()}else{$(this).show()}j.children(".distance").remove();j.append("<div class='distance'>Distanz: "+f+"</div>")});if($('[class="venueDiv"]:visible').length<1){$("#noVenueFoundNotifier").show()}else{$("#noVenueFoundNotifier").hide()}}function setNoteDialog(){$("#setNoteDialog").dialog({modal:true,resizable:false,title:"Notiz erstellen",buttons:{Ok:function(){var a=$("#noteInput").val();vote_set_note(a);$("#setNoteDialog").dialog("close");$(this).dialog("close")}},width:"auto"})}function handle_href_reference_details(d,a,c,b){$.ajax({type:"POST",url:"nearplaces.php",data:{action:"details",id:d,reference:a,sensor:isMobileDevice(),userid:$("#userid").html()},dataType:"json",async:false,success:function(e){if(typeof e.alert!="undefined"){alert(e.alert)}if(typeof e.result.website!="undefined"){window.open(e.result.website,"_blank")}else{window.open("https://www.google.com/#q="+c,"_blank")}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){handle_href_reference_details(d,a,c,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function get_alt_venues(e,c,a,d,f,b){$.ajax({type:"POST",url:"nearplaces.php",data:{action:"nearbysearch_staged",lat:e,lng:c,radius:a,radius_max:d,sensor:isMobileDevice(),userid:$("#userid").html()},dataType:"json",success:function(g){if(typeof g.alert!="undefined"){alert(g.alert)}else{return f(g)}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){get_alt_venues(e,c,a,d,f,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function init_venues_alt(){var c=$("#lat").html();var a=$("#lng").html();$("#table_voting_alt").hide();$("#div_voting_alt_loader").show();var b=new Array();get_alt_venues(c,a,1000,$("#distance").val(),function(d){data=new Array();$(d).each(function(h,i){var k=distanceLatLng(c,a,i.lat,i.lng);var g=Math.floor(Number((k).toFixed(2))*1000);var j="-";if(i.rating){j=i.rating}var f="<a href='"+i.maps_href+"' target='_blank'><span class='icon sprite sprite-icon_pin_map' title='Google Maps Route'></span></a>";if($("#show_voting").length){f+="<a href='javascript:void(0)' onclick='vote_up(\""+i.name+"\")'><span class='icon sprite sprite-icon_hand_pro' title='Vote Up'></span></a>					<a href='javascript:void(0)' onclick='vote_down(\""+i.name+"\")'><span class='icon sprite sprite-icon_hand_contra' title='Vote Down'></span></a>"}data[h]=new Array(i.href,g,j,f)});var e=$("#table_voting_alt").dataTable({aaData:data,bSort:true,bDestroy:true,aaSorting:[[1,"asc"],[2,"desc"]],bLengthChange:false,bAutoWidth:true,iDisplayLength:8,sPaginationType:"full_numbers",bInfo:false,aoColumns:[{sTitle:"Name"},{sTitle:"Distanz [m]",sClass:" center"},{sTitle:"Rating",sClass:" center"},{sTitle:"Aktionen",sClass:" center"}],oLanguage:{sProcessing:"Bitte warten...",sLengthMenu:"_MENU_ Einträge anzeigen",sZeroRecords:"<p class='bold'>Leider nichts gefunden :(</p>",sInfo:"_START_ bis _END_ von _TOTAL_ Einträgen",sInfoEmpty:"0 bis 0 von 0 Einträgen",sInfoFiltered:"(gefiltert von _MAX_  Einträgen)",sInfoPostFix:"",sSearch:"Filter:",sUrl:"",oPaginate:{sFirst:"Anfang",sPrevious:"Zurück",sNext:"Weiter",sLast:"Ende"}}});$("#div_voting_alt_loader").hide();$("#table_voting_alt").show();if(e.length>0){e.fnAdjustColumnSizing()}$("#table_voting_alt").parent().find('input[type="text"]').attr("type","search");$("#setAlternativeVenuesDialog").dialog("option","position","center")},0)}function setAlternativeVenuesDialog(){init_venues_alt();$("#setAlternativeVenuesDialog").dialog({modal:true,resizable:false,title:"Lokale in der Nähe",buttons:{"Schließen":function(){$(this).dialog("close")}},width:"auto"})}function updateVoteSettingsDialog(){$("#vote_reminder").attr("disabled",$("#voted_mail_only").is(":checked"))}function setVoteSettingsDialog(){$("#setVoteSettingsDialog").dialog({modal:true,resizable:false,title:"Spezial-Votes & Einstellungen",buttons:{"Speichern / Schließen":function(){$.ajax({type:"POST",url:"emails.php",data:{action:"email_config_set",email:$("#email").val(),vote_reminder:$("#vote_reminder").is(":checked"),voted_mail_only:$("#voted_mail_only").is(":checked"),userid:$("#userid").html()},dataType:"json",success:function(a){if(typeof a.alert!="undefined"){alert(a.alert)}},error:function(){alert("Fehler beim Setzen der Vote-Einstellungen.")}});$(this).dialog("close")}},width:"auto"})}$(document).ready(function(){var a=false;$(document).on("locationReady",function(){a=true;head.ready("cookie",function(){var b=$.cookie("distance");if(typeof b=="undefined"){b=$("#distance_default").html()}$("#sliderDistance").slider({value:b,min:100,max:10000,step:100,slide:function(c,d){setDistance(d.value)}});$("#socialShare").show();$("#loadingContainer").hide();setDistance(b)});$(".lat_lng_link").each(function(c,d){var b=$(this).prop("href");b=b.replace("@@lat_lng@@",$("#lat").html()+","+$("#lng").html());$(this).prop("href",b)});$("a").tooltip();$("span").tooltip();$("div").tooltip();$("input").tooltip()});head.ready("cookie",function(){var b=$.cookie("location");if(typeof b!="undefined"&&b&&b.length){setLocation(b,false,0)}else{setLocation(null,false,0)}});setTimeout(function(){if(!a){$(document).trigger("locationReady")}},10000);if($("#show_voting").length){vote_get()}$("#distance").on("input change",function(){setDistance($(this).val())});$("#date").bind("change",function(){document.location=window.location.protocol+"//"+window.location.host+window.location.pathname+"?date="+$(this).val()});$("#locationForm").submit(function(c){var b=$("#locationInput").val();setLocation(b,false,0);$("#setLocationDialog").dialog("close");c.preventDefault()});$("#noteForm").submit(function(c){var b=$("#noteInput").val();vote_set_note(b);$("#setNoteDialog").dialog("close");c.preventDefault()});$("#setVoteSettingsDialog").change(function(){updateVoteSettingsDialog()});updateVoteSettingsDialog()});window.alert=function(c,a,d,b){if(typeof a=="undefined"){var a="Hinweis"}if(typeof d=="undefined"||d){c='<table><tr><td><span class="ui-icon ui-icon-alert" style="margin-right: 5px"></span></td><td>'+c+"</td></tr></table>"}if(typeof b=="undefined"){b="auto"}$(".alert").remove();$(document.createElement("div")).attr({title:a,"class":"alert"}).html(c).dialog({title:a,resizable:false,modal:true,width:b,buttons:{OK:function(){$(this).dialog("close")}}})};