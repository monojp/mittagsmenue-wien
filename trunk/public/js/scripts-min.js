var intervalVotes=false;var venueDivDisplay=null;var usedGeolocation=false;var oldVoteData=null;var voting_over_interval_multiplier=1;var venues_ajax_query=Array();var ajax_retry_time_max=500;var ajax_retry_count_max=5;function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|MIDP|Nokia|J2ME/i.test(navigator.userAgent)}$.extend({keys:function(c){var b=[];$.each(c,function(a){b.push(a)});return b}});var notify_on=false;function vote_helper(d,b,c,a){$.ajax({type:"POST",url:"vote.php",data:{action:d,identifier:b,note:c},dataType:"json",success:function(e){if(intervalVotes){clearInterval(intervalVotes)}if(typeof e.voting_over!="undefined"&&e.voting_over||!e||typeof e.alert!="undefined"){voting_over_interval_multiplier+=0.1}else{voting_over_interval_multiplier=1}intervalVotes=setInterval(function(){vote_get()},Math.floor(5000*voting_over_interval_multiplier));if(typeof JSON!="undefined"&&JSON.stringify(oldVoteData)==JSON.stringify(e)){return}if(typeof e.alert!="undefined"){alert(e.alert)}else{if(typeof e.html!="undefined"){$("#dialog_ajax_data").html(e.html);$("#dialog_vote_summary").css("display","table");if(notify_on){$("#dialog_vote_summary").effect("highlight");$("#audio_notification").get(0).play()}else{notify_on=true}}else{if(intervalVotes){$("#dialog_vote_summary").hide()}}}oldVoteData=e},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){vote_helper(d,b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Setzen des Votes.")}}})}function vote_up(a){notify_on=false;vote_helper("vote_up",a,null,0)}function vote_down(a){notify_on=false;vote_helper("vote_down",a,null,0)}function vote_special(a){notify_on=false;vote_helper("vote_special",a,null,0)}function vote_set_note(a){notify_on=false;vote_helper("vote_set_note",null,a,0)}function vote_get(){vote_helper("vote_get",null,null,0)}function vote_delete(){notify_on=false;vote_helper("vote_delete",null,null,0)}function positionHandler(a){lat=a.coords.latitude;lng=a.coords.longitude;$.ajax({type:"POST",url:"locator.php",data:{action:"latlngToAddress",lat:lat,lng:lng},dataType:"json",success:function(b){if(b&&typeof b.address!="undefined"&&b.address){usedGeolocation=true;$("#location").html(b.address);$("#locationInput").val(b.address);sortVenuesAfterPosition(lat,lng)}},error:function(){sortVenuesAfterPosition(lat,lng)}})}function positionErrorHandler(a){sortVenuesAfterPosition($("#lat").html(),$("#lng").html())}function distanceLatLng(g,m,f,k){g=parseFloat(g);m=parseFloat(m);f=parseFloat(f);k=parseFloat(k);var e=Math.PI/180;g*=e;m*=e;f*=e;k*=e;var d=6372.797;var h=f-g;var i=k-m;var l=Math.sin(h/2)*Math.sin(h/2)+Math.cos(g)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2);var j=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));var b=d*j;return b}function sortVenuesAfterPosition(d,c){$("#lat").html(d);$("#lng").html(c);var a=new Array();$.each($('[class="venueDiv"]'),function(){var g=$(this).prop("id");var e=$(this).children(".lat").html();var f=$(this).children(".lng").html();a[g]=distanceLatLng(d,c,e,f)});var b=$('[class="venueDiv"]');b.sort(function(g,f){var e=$(g).prop("id");var j=$(f).prop("id");var i=a[e];var h=a[j];if(i>h){return 1}else{if(i<h){return -1}else{return 0}}});$("#venueContainer").html(b);$(document).trigger("locationReady")}function setLocation(b,c,a){if(!b||c){if((isMobileDevice()||c)&&navigator.geolocation){navigator.geolocation.getCurrentPosition(positionHandler,positionErrorHandler,{timeout:5000})}else{sortVenuesAfterPosition($("#lat").html(),$("#lng").html());usedGeolocation=false;$(document).trigger("locationReady")}$.removeCookie("location");return}usedGeolocation=false;$.ajax({type:"POST",url:"locator.php",data:{action:"addressToLatLong",address:b},dataType:"json",success:function(d){if(d&&typeof d.lat!="undefined"&&d.lat&&typeof d.lng!="undefined"&&d.lng){$("#location").html(b);$("#locationInput").val(b);sortVenuesAfterPosition(d.lat,d.lng);$.cookie("location",b,{expires:7})}else{$("#locationInput").val($("#location").html());alert("Keine Geo-Daten zu dieser Adresse gefunden.")}},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){setLocation(b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abrufen der Geo-Position. Bitte Internetverbindung überprüfen.")}}})}function setLocationDialog(a){$("#setLocationDialog").dialog({modal:true,title:"Adresse festlegen",buttons:{Ok:function(){var b=$("#locationInput").val();setLocation(b,false,0);$("#setLocationDialog").dialog("close");$(this).dialog("close")},Abbrechen:function(){$(this).dialog("close")}},width:"380"});$(a).tooltip("close")}function setDistance(a){if(typeof a!="undefined"){$("#sliderDistance").slider("option","value",a);$("#distance").val(a);$.cookie("distance",a,{expires:7})}get_venues_distance()}function showLocation(d){var g=$("#lat").html()+","+$("#lng").html();var f="http://maps.googleapis.com/maps/api/staticmap?center="+g+"&zoom=15&language=de&size=400x300&sensor=false&markers=color:red|"+g;var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var c=0;var b="";$.each($('[class="venueDiv"]:visible'),function(){var h=$(this).children(".lat").html();var i=$(this).children(".lng").html();var j=$(this).children('[class="title"]').children("a").html();f+="&markers=color:red|label:"+a[c]+"|"+h+","+i;if(c<5){b+=a[c]+": "+j+"<br />"}c++;if(c>=a.length){c=0}});var e='<img width="400" height="300" src="'+f+'"></img>';e+='<br /><div class="locationMapLegend" style="">'+b+"</div>";alert(e,$("#location").html(),false,425);$(d).tooltip("close")}function get_venues_distance(){var d=$("#lat").html();var b=$("#lng").html();var e=$("#distance").val();var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var c=0;$.each($('[class="venueDiv"]'),function(){var h=$(this).children(".lat").html();var k=$(this).children(".lng").html();var j=$(this);var f="";var i=distanceLatLng(d,b,h,k);var g=Math.floor(Number((i).toFixed(2))*1000);if(i>=1){f="~ "+i.toFixed(1)+" km"}else{f="~ "+g+" m"}if(g>e){$(this).hide()}else{$(this).show()}j.children(".distance").remove();j.append("<div class='distance'>Distanz: "+f+"</div>")});if($('[class="venueDiv"]:visible').length<1){$("#noVenueFoundNotifier").show()}else{$("#noVenueFoundNotifier").hide()}}function setNoteDialog(){$("#setNoteDialog").dialog({modal:true,title:"Notiz erstellen",buttons:{Ok:function(){var a=$("#noteInput").val();vote_set_note(a);$("#setNoteDialog").dialog("close");$(this).dialog("close")}},width:"400"})}function handle_href_reference_details(d,a,c,b){$.ajax({type:"POST",url:"nearplaces.php",data:{action:"details",id:d,reference:a,sensor:isMobileDevice()},dataType:"json",async:false,success:function(e){if(typeof e.alert!="undefined"){alert(e.alert)}if(typeof e.result.website!="undefined"){window.open(e.result.website,"_blank")}else{window.open("https://www.google.com/#q="+c,"_blank")}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){handle_href_reference_details(d,a,c,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function get_alt_venues(e,d,a,c,f,b){if(c.length>=10){return f(new Array())}$.ajax({type:"POST",url:"nearplaces.php",data:{action:"nearbysearch_full",lat:e,lng:d,radius:a,sensor:isMobileDevice()},dataType:"json",success:function(g){if(typeof g.alert!="undefined"){alert(g.alert)}else{return f(g)}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){get_alt_venues(e,d,a,c,f,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function init_venues_alt(){var c=$("#lat").html();var a=$("#lng").html();$("#table_voting_alt").hide();$("#div_voting_alt_loader").show();var b=new Array();get_alt_venues(c,a,650,b,function(d){b=b.concat(d);get_alt_venues(c,a,$("#distance").val(),d,function(e){b=b.concat(e);data=new Array();$(b).each(function(i,j){var l=distanceLatLng(c,a,j.lat,j.lng);var h=Math.floor(Number((l).toFixed(2))*1000);var k="-";if(j.rating){k=j.rating}var g="<a href='"+j.maps_href+"' target='_blank'><span class='icon sprite sprite-icon_pin_map' title='Google Maps Route'></span></a>";if($("#show_voting").length){g+="<a href='javascript:void(0)' onclick='vote_up(\""+j.name+"\")'><span class='icon sprite sprite-icon_hand_pro' title='Vote Up'></span></a>						<a href='javascript:void(0)' onclick='vote_down(\""+j.name+"\")'><span class='icon sprite sprite-icon_hand_contra' title='Vote Down'></span></a>"}data[i]=new Array(j.href,h,k,g)});var f=$("#table_voting_alt").dataTable({aaData:data,bSort:true,bDestroy:true,aaSorting:[[1,"asc"],[2,"desc"]],bLengthChange:false,bAutoWidth:true,iDisplayLength:8,sPaginationType:"full_numbers",bInfo:false,aoColumns:[{sTitle:"Name"},{sTitle:"Distanz [m]",sClass:" center"},{sTitle:"Rating",sClass:" center"},{sTitle:"Aktionen",sClass:" center"}],oLanguage:{sProcessing:"Bitte warten...",sLengthMenu:"_MENU_ Einträge anzeigen",sZeroRecords:"<p class='bold'>Leider nichts gefunden :(</p>",sInfo:"_START_ bis _END_ von _TOTAL_ Einträgen",sInfoEmpty:"0 bis 0 von 0 Einträgen",sInfoFiltered:"(gefiltert von _MAX_  Einträgen)",sInfoPostFix:"",sSearch:"Filter:",sUrl:"",oPaginate:{sFirst:"Anfang",sPrevious:"Zurück",sNext:"Weiter",sLast:"Ende"}}});$("#div_voting_alt_loader").hide();$("#table_voting_alt").show();if(f.length>0){f.fnAdjustColumnSizing()}$("#setAlternativeVenuesDialog").dialog("option","position","center")},0)},0)}function setAlternativeVenuesDialog(){init_venues_alt();$("#setAlternativeVenuesDialog").dialog({modal:true,title:"Lokale in der Nähe",buttons:{"Schließen":function(){$(this).dialog("close")}},width:"750"})}function updateVoteSettingsDialog(){$("#vote_reminder").attr("disabled",$("#voted_mail_only").is(":checked"))}function setVoteSettingsDialog(){$("#setVoteSettingsDialog").dialog({modal:true,title:"Spezial-Votes & Einstellungen",buttons:{"Speichern / Schließen":function(){$.ajax({type:"POST",url:"emails.php",data:{action:"email_config_set",email:$("#email").val(),vote_reminder:$("#vote_reminder").is(":checked"),voted_mail_only:$("#voted_mail_only").is(":checked")},dataType:"json",success:function(a){if(typeof a.alert!="undefined"){alert(a.alert)}},error:function(){alert("Fehler beim Setzen der Vote-Einstellungen.")}});$(this).dialog("close")}},width:"440"})}$(document).ready(function(){var a=false;$(document).on("locationReady",function(){a=true;head.ready("cookie",function(){var b=$.cookie("distance");if(typeof b=="undefined"){b=$("#distance_default").html()}$("#sliderDistance").slider({value:b,min:100,max:10000,step:100,slide:function(c,d){setDistance(d.value)}});$("#socialShare").show();$("#loadingContainer").hide();setDistance(b)});$(".lat_lng_link").each(function(c,d){var b=$(this).prop("href");b=b.replace("@@lat_lng@@",$("#lat").html()+","+$("#lng").html());$(this).prop("href",b)});$("a").tooltip();$("span").tooltip();$("div").tooltip();$("input").tooltip()});head.ready("cookie",function(){var b=$.cookie("location");if(typeof b!="undefined"&&b&&b.length){setLocation(b,false,0)}else{setLocation(null,false,0)}if($("#overlay_info_version").length){var d=$.trim($("#overlay_info_version").html());var c=$.trim($.cookie("overlay_info_version"));if(d!=c){$("#overlay_info").show("slide",{direction:"up"});setTimeout(function(){$.cookie("overlay_info_version",d,{expires:7});$("#overlay_info").hide("slide",{direction:"up"})},10000)}}});setTimeout(function(){if(!a){$(document).trigger("locationReady")}},10000);if($("#show_voting").length){vote_get()}$("#datePicker").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(2012,10,30),maxDate:"1M",onSelect:function(c,b){document.location=window.location.protocol+"//"+window.location.host+window.location.pathname+"?date="+c}});$("#distance").on("input change",function(){setDistance($(this).val())});$("#dateHeader").click(function(b){$("#dateHeader").tooltip("close");$("#datePicker").datepicker("show");$("#datePicker").datepicker("setDate",$("#date_GET").val())});$("#locationForm").submit(function(c){var b=$("#locationInput").val();setLocation(b,false,0);$("#setLocationDialog").dialog("close");c.preventDefault()});$("#noteForm").submit(function(c){var b=$("#noteInput").val();vote_set_note(b);$("#setNoteDialog").dialog("close");c.preventDefault()});$("#setVoteSettingsDialog").change(function(){updateVoteSettingsDialog()});updateVoteSettingsDialog()});window.alert=function(c,a,d,b){if(typeof a=="undefined"){var a="Hinweis"}if(typeof d=="undefined"||d){c='<table><tr><td><span class="ui-icon ui-icon-alert" style="margin-right: 5px"></span></td><td>'+c+"</td></tr></table>"}if(typeof b=="undefined"){b=300}$(document.createElement("div")).attr({title:a,"class":"alert"}).html(c).dialog({title:a,resizable:false,modal:true,width:b,buttons:{OK:function(){$(this).dialog("close")}}})};